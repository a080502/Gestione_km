<!DOCTYPE html>
<html>
<head>
    <title>Test Flag Toggle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-table {
            table-layout: fixed !important;
            width: 100% !important;
        }
        .flag-col { width: 60px !important; min-width: 60px !important; max-width: 60px !important; }
        .data-col { width: 100px !important; }
        .user-col { width: 120px !important; }
        .actions-col { width: 100px !important; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Test Flag Toggle</h2>
        
        <table class="table test-table" style="table-layout: fixed !important; width: 100% !important;">
            <thead class="table-danger">
                <tr>
                    <th class="flag-col" style="width: 60px !important; text-align: center;">FLAG</th>
                    <th class="data-col" style="width: 100px !important;">DATA</th>
                    <th class="user-col" style="width: 120px !important;">UTENTE</th>
                    <th class="actions-col" style="width: 100px !important; text-align: center;">AZIONI</th>
                </tr>
            </thead>
            <tbody>
                <tr data-id="1">
                    <td class="flag-col" style="width: 60px !important; text-align: center; padding: 0.5rem;">
                        <span class="text-muted">-</span>
                    </td>
                    <td class="data-col" style="width: 100px !important;">31/08/2025</td>
                    <td class="user-col" style="width: 120px !important;">denis</td>
                    <td class="actions-col" style="width: 100px !important; text-align: center;">
                        <button class="btn btn-sm btn-outline-warning" onclick="toggleFlag(1)">
                            <i class="bi bi-flag"></i>
                        </button>
                    </td>
                </tr>
                <tr data-id="2">
                    <td class="flag-col" style="width: 60px !important; text-align: center; padding: 0.5rem;">
                        <i class="bi bi-flag-fill text-primary"></i>
                    </td>
                    <td class="data-col" style="width: 100px !important;">04/10/2024</td>
                    <td class="user-col" style="width: 120px !important;">elena.conti</td>
                    <td class="actions-col" style="width: 100px !important; text-align: center;">
                        <button class="btn btn-sm btn-outline-success" onclick="toggleFlag(2)">
                            <i class="bi bi-flag-slash"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="mt-3">
            <button class="btn btn-primary" onclick="addRow()">Aggiungi Riga</button>
            <button class="btn btn-secondary" onclick="checkStructure()">Controlla Struttura</button>
        </div>
        
        <div id="debug" class="mt-3"></div>
    </div>

    <script>
        let rowCounter = 3;
        
        function toggleFlag(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const flagCell = row.querySelector('td:first-child');
            const button = row.querySelector('button');
            
            console.log('Toggling flag for row:', id);
            console.log('Flag cell:', flagCell);
            console.log('Flag cell position:', Array.from(row.children).indexOf(flagCell));
            
            if (flagCell.innerHTML.includes('bi-flag-fill')) {
                // Rimuovi flag
                flagCell.innerHTML = '<span class="text-muted">-</span>';
                button.className = 'btn btn-sm btn-outline-warning';
                button.innerHTML = '<i class="bi bi-flag"></i>';
                row.className = '';
            } else {
                // Aggiungi flag
                flagCell.innerHTML = '<i class="bi bi-flag-fill text-primary"></i>';
                button.className = 'btn btn-sm btn-outline-success';
                button.innerHTML = '<i class="bi bi-flag-slash"></i>';
                row.className = 'table-info';
            }
            
            // Forza gli stili
            flagCell.style.width = '60px';
            flagCell.style.minWidth = '60px';
            flagCell.style.maxWidth = '60px';
            flagCell.style.textAlign = 'center';
            
            checkStructure();
        }
        
        function addRow() {
            const tbody = document.querySelector('tbody');
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-id', rowCounter);
            newRow.innerHTML = `
                <td class="flag-col" style="width: 60px !important; text-align: center; padding: 0.5rem;">
                    <span class="text-muted">-</span>
                </td>
                <td class="data-col" style="width: 100px !important;">01/01/2025</td>
                <td class="user-col" style="width: 120px !important;">nuovo.utente</td>
                <td class="actions-col" style="width: 100px !important; text-align: center;">
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleFlag(${rowCounter})">
                        <i class="bi bi-flag"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            rowCounter++;
        }
        
        function checkStructure() {
            const rows = document.querySelectorAll('tbody tr');
            let debug = '<h5>Struttura Tabella:</h5>';
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                debug += `<p>Riga ${index + 1}: ${cells.length} celle</p>`;
                cells.forEach((cell, cellIndex) => {
                    debug += `&nbsp;&nbsp;- Cella ${cellIndex + 1}: ${cell.className} - ${cell.innerHTML.substring(0, 30)}...</p>`;
                });
            });
            
            document.getElementById('debug').innerHTML = debug;
        }
        
        // Controlla struttura al caricamento
        document.addEventListener('DOMContentLoaded', checkStructure);
    </script>
</body>
</html>