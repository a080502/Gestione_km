<!DOCTYPE html>
<html>
<head>
    <title>Debug Struttura Tabella</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Debug Struttura Tabella Report Avanzato</h2>
        <button class="btn btn-primary" onclick="checkTableStructure()">Controlla Struttura</button>
        <div id="debug-output" class="mt-3"></div>
        
        <script>
            function checkTableStructure() {
                // Apri la pagina reale in un iframe nascosto per analizzarla
                const iframe = document.createElement('iframe');
                iframe.src = 'report_avanzato.php';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                iframe.onload = function() {
                    const doc = iframe.contentDocument;
                    const table = doc.querySelector('.table-fixed');
                    
                    if (table) {
                        const headerCells = table.querySelectorAll('thead th');
                        const rows = table.querySelectorAll('tbody tr');
                        
                        let output = `<h4>Analisi Tabella:</h4>`;
                        output += `<p><strong>Header:</strong> ${headerCells.length} colonne</p>`;
                        
                        output += `<h5>Headers:</h5><ul>`;
                        headerCells.forEach((cell, index) => {
                            output += `<li>Colonna ${index + 1}: ${cell.textContent.trim()}</li>`;
                        });
                        output += `</ul>`;
                        
                        output += `<h5>Righe Dati:</h5>`;
                        rows.forEach((row, rowIndex) => {
                            const cells = row.querySelectorAll('td');
                            const anomaliaId = row.getAttribute('data-anomalia-id');
                            const rowClass = row.className;
                            const hasFlag = row.querySelector('.bi-flag-fill') !== null;
                            
                            output += `<p><strong>Riga ${rowIndex + 1}</strong> (ID: ${anomaliaId}, Class: ${rowClass}, Flagged: ${hasFlag}): `;
                            output += `${cells.length} celle</p>`;
                            
                            if (cells.length !== headerCells.length) {
                                output += `<p style="color: red;">⚠️ ERRORE: Riga ha ${cells.length} celle ma header ha ${headerCells.length} colonne!</p>`;
                            }
                            
                            // Mostra contenuto ultima cella (dovrebbe essere flag)
                            if (cells.length > 0) {
                                const lastCell = cells[cells.length - 1];
                                output += `<p>Ultima cella: ${lastCell.innerHTML.substring(0, 100)}...</p>`;
                            }
                        });
                        
                        document.getElementById('debug-output').innerHTML = output;
                    } else {
                        document.getElementById('debug-output').innerHTML = '<p style="color: red;">Tabella non trovata!</p>';
                    }
                    
                    // Rimuovi iframe
                    document.body.removeChild(iframe);
                };
            }
        </script>
    </div>
</body>
</html>